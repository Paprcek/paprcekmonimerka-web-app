{% load static i18n %}
    
<style>
    .cell {
        /* Standardn√≠ bu≈àka pro dark mode */
        border: 2px solid #4CAF50; /* Zelen√Ω okraj */
        text-align: center;
        line-height: 100px;
        font-size: 40px;
        cursor: pointer;
        transition: background-color 0.2s;
        user-select: none;
        color: #f3f4f6; /* Svƒõtl√Ω text pro 'X' a 'O' */
    }
    
    .cell:hover {
        /* Tmav≈°√≠ pozad√≠ p≈ôi hoveru */
        background-color: #1f2937; 
    }
    
    /* V√≠tƒõzn√Ω stav (Victory/Won) */
    .won {
        background-color: #155724; /* Tmavƒõ zelen√© pozad√≠ */
        color: #4CAF50; /* Jasnƒõ zelen√Ω text */
        font-weight: bold;
    }
    
    /* Rem√≠za (Draw) */
    .draw {
        background-color: #333; /* ≈†ed√Ω odst√≠n */
        color: #f3f4f6; /* Svƒõtl√Ω text */
    }

    /* Ostatn√≠ styly pro p≈ôep√≠naƒç jazyka */
    .language-switcher a, .language-switcher button {
        padding: 5px;
        text-decoration: none;
        color: #f3f4f6; /* Svƒõtl√Ω text */
        background: none;
        border: none;
        cursor: pointer;
        font-family: 'Source Code Pro', monospace; /* Tv√© k√≥dersk√© p√≠smo */
        font-size: 1rem;
    }
    .language-switcher a.active, .language-switcher button.active {
        font-weight: bold;
        color: #4CAF50; /* Jasnƒõ zelen√Ω akcent */
    }
</style>

<div class="language-switcher">
    {% get_current_language as LANGUAGE_CODE %}
    {% get_language_info for 'cs' as lang_cs %}
    {% get_language_info for 'en' as lang_en %}

    <form action="{% url 'set_language' %}" method="post" style="display: inline;">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.get_full_path }}">
        <input name="language" type="hidden" value="cs">
        <button type="submit" {% if LANGUAGE_CODE == 'cs' %}class="active"{% endif %}>{{ lang_cs.name_local }}</button>
    </form>
    |
    <form action="{% url 'set_language' %}" method="post" style="display: inline;">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.get_full_path }}">
        <input name="language" type="hidden" value="en">
        <button type="submit" {% if LANGUAGE_CODE == 'en' %}class="active"{% endif %}>{{ lang_en.name_local }}</button>
    </form>
</div>

<h2>{% trans "Hra Pi≈°kvorky proti AI" %}</h2>

<div id="game-status">{% trans "Stav hry: Hraje" %} **X** ({% trans "Ty" %})</div>
<div id="game-board" style="display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); gap: 5px; margin-top: 10px;">
    {% for i in "012345678"|make_list %}
        <div class="cell" data-index="{{ i }}">
            {{ game.board|slice:i|slice:"-1" }}
        </div>
    {% endfor %}
</div>

<p><a href="{% url 'new_game' %}">{% trans "Zaƒç√≠t novou hru" %}</a></p>

<input type="hidden" id="game-id" value="{{ game.id }}">
{% csrf_token %}

<script>
    const gameBoard = document.getElementById('game-board');
    const statusDisplay = document.getElementById('game-status');
    const cells = document.querySelectorAll('.cell');
    const gameId = document.getElementById('game-id').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    let isGameOver = "{{ game.status }}" !== 'Active';

    // 1. Funkce pro vykreslen√≠ stavu
    function renderBoard(boardString) {
        cells.forEach((cell, index) => {
            const mark = boardString[index];
            cell.textContent = mark === '.' ? '' : mark;
            cell.classList.remove('won', 'draw');
        });
    }
    
    // 2. Funkce pro aktualizaci stavu z API
    function updateStatus(status, winner) {
        isGameOver = status !== 'Active';

        let statusText = '';
        if (status === 'Active') {
            statusText = "{% trans 'Stav hry: Hraje' %} **X** ({% trans 'Ty' %})";
        } else if (winner === 'X') {
            statusText = "{% trans 'Stav hry: VYHR√ÅL JSI (X)!' %} üéâ";
            highlightWinner(winner);
        } else if (winner === 'O') {
            statusText = "{% trans 'Stav hry: Prohr√°l/a jsi. Vyhr√°la AI (O).' %} ü§ñ";
            highlightWinner(winner);
        } else if (status === 'Draw') {
            statusText = "{% trans 'Stav hry: Rem√≠za!' %}";
            gameBoard.classList.add('draw');
        }
        statusDisplay.innerHTML = statusText;
    }

    function highlightWinner(player) {
        cells.forEach(cell => {
            if (cell.textContent === player) {
                cell.classList.add('won');
            }
        });
    }

    // 3. Hlavn√≠ funkce pro proveden√≠ tahu
    async function handleMove(index) {
        if (isGameOver) return; 
        
        const response = await fetch(`{% url 'make_move' game.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ index: index })
        });

        const data = await response.json();

        if (response.ok) {
            renderBoard(data.board);
            updateStatus(data.status, data.winner);
        } else {
            alert(data.error || "{% trans 'Do≈°lo k chybƒõ p≈ôi prov√°dƒõn√≠ tahu.' %}");
        }
    }

    // 4. P≈ôid√°n√≠ event listener≈Ø pro kliknut√≠
    cells.forEach(cell => {
        cell.addEventListener('click', (event) => {
            const index = event.target.dataset.index;
            if (event.target.textContent === '' && !isGameOver) {
                handleMove(parseInt(index));
            }
        });
    });

    // Inicializace p≈ôi naƒçten√≠ str√°nky
    updateStatus("{{ game.status }}", "{{ game.status|slice:'0:1' }}");
    renderBoard("{{ game.board }}");
</script>
